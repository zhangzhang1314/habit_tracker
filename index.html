<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¹ æƒ¯æ‰“å¡ Pro v15 (æ—¥å†ç®—æœ¯ä¿®å¤ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Chosen Palette: Warm Neutrals -->
    <!-- Application Structure Plan:
         1. Views: Track, Add, Settings.
         2. Fix: Corrected the 'pad' function and date concatenation logic to enforce String concatenation instead of Number addition.
            (e.g., fixed bug where 2025 + 11 + 25 became 2061 instead of "20251125").
         3. Preserved: All previous features and listeners.
    -->
    <style>
        .hidden { display: none; }
        .view { display: none; }
        .view.active { display: block; }
        
        .fireworks {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.1); z-index: 100;
            pointer-events: none; opacity: 0; transition: opacity 0.1s ease-out;
        }
        .fireworks.active { opacity: 1; transition: opacity 0.05s ease-in; }
        .firework {
            position: absolute; width: 4px; height: 4px; background-color: #fff;
            border-radius: 50%; opacity: 0; animation: burst 0.3s ease-out forwards;
        }
        @keyframes burst {
            0% { transform: scale(0); opacity: 1; }
            100% { transform: scale(2.5) translate(var(--tx), var(--ty)); opacity: 0; }
        }

        .chart-scroll-wrapper { width: 100%; overflow-x: auto; scrollbar-width: thin; scrollbar-color: #fb923c #fff7ed; }
        .chart-body { position: relative; height: 350px; }
        
        .delete-habit-btn:hover { background-color: #fecaca; color: #dc2626; }
        textarea { font-family: monospace; font-size: 11px; }
    </style>
</head>
<body class="bg-orange-50 text-orange-900 font-sans min-h-screen">

    <div class="max-w-4xl mx-auto p-4 sm:p-6 pb-20">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl sm:text-3xl font-bold text-orange-800 tracking-wide">ä¹ æƒ¯æ‰“å¡ Pro</h1>
            <button id="nav-settings" class="text-sm text-orange-600 underline hover:text-orange-800">âš™ï¸ è®¾ç½®/æ—¥å†</button>
        </div>

        <!-- å¯¼èˆª -->
        <div class="flex justify-center space-x-4 mb-6 border-b border-orange-200 pb-2">
            <button id="nav-track" class="nav-btn px-6 py-2 rounded-t-lg font-medium transition-all duration-200">æ‰“å¡ & ç»Ÿè®¡</button>
            <button id="nav-add" class="nav-btn px-6 py-2 rounded-t-lg font-medium transition-all duration-200">æ·»åŠ ä¹ æƒ¯</button>
        </div>

        <!-- è§†å›¾: æ‰“å¡ä¸ç»Ÿè®¡ -->
        <div id="view-track" class="view active space-y-8">
            <div class="bg-white p-5 sm:p-6 rounded-xl shadow-sm border border-orange-100">
                <h2 class="text-xl font-bold mb-4 text-orange-800 flex items-center">
                    <span class="mr-2">ğŸ“</span> ä»Šæ—¥ä¹ æƒ¯
                </h2>
                <div id="habit-checklist-container" class="space-y-4"></div>
            </div>

            <div class="bg-white p-5 sm:p-6 rounded-xl shadow-sm border border-orange-100 relative">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-orange-800 flex items-center">
                        <span class="mr-2">ğŸ“…</span> æ‰“å¡æ—¥å¿— (ä»Šæ—¥)
                    </h2>
                    <button id="btn-initiate-clear-logs" class="bg-red-100 text-red-600 px-3 py-1.5 rounded-lg text-xs font-semibold hover:bg-red-200 transition-colors">
                        æ¸…ç©ºæ•°æ®
                    </button>
                </div>
                <div id="daily-log-list" class="space-y-2 max-h-60 overflow-y-auto"></div>
            </div>

            <div class="bg-white p-5 sm:p-6 rounded-xl shadow-sm border border-orange-100">
                <h2 class="text-xl font-bold mb-4 text-orange-800 flex items-center">
                    <span class="mr-2">ğŸ†</span> æœˆåº¦æ’è¡Œ (æœ¬æœˆ)
                </h2>
                <div id="monthly-stats-list" class="space-y-2"></div>
            </div>

            <div class="bg-white p-5 sm:p-6 rounded-xl shadow-sm border border-orange-100">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                    <h2 class="text-xl font-bold text-orange-800 flex items-center">
                        <span class="mr-2">ğŸ“Š</span> æ¯æ—¥ç»Ÿè®¡
                    </h2>
                    <div class="flex items-center space-x-2 mt-2 sm:mt-0 bg-orange-50 px-3 py-1 rounded-full">
                        <span class="text-xs text-orange-600">è§†è§’:</span>
                        <span class="text-xs">â–</span>
                        <input type="range" id="zoom-slider" min="30" max="150" value="60" class="w-24 h-2 bg-orange-200 rounded-lg appearance-none cursor-pointer accent-orange-500">
                        <span class="text-xs">â•</span>
                    </div>
                </div>
                <div class="chart-scroll-wrapper border-t border-orange-50 pt-4">
                    <div class="chart-body" id="chart-body">
                        <canvas id="daily-bar-chart"></canvas>
                    </div>
                </div>
                <p class="text-center text-xs text-gray-400 mt-2">â† å·¦å³æ»‘åŠ¨æŸ¥çœ‹æ›´å¤šæ—¥æœŸ â†’</p>
            </div>
        </div>

        <!-- è§†å›¾: æ·»åŠ ä¹ æƒ¯ -->
        <div id="view-add" class="view">
            <div class="bg-white p-5 sm:p-6 rounded-xl shadow-sm border border-orange-100">
                <h2 class="text-xl font-bold mb-4 text-orange-800">â• æ·»åŠ æ–°ä¹ æƒ¯</h2>
                <div class="space-y-4">
                    <div>
                        <label for="habit-l1" class="block text-sm font-medium text-orange-700 mb-1">ä¸€çº§åˆ†ç±» (ä¾‹å¦‚: ç”Ÿæ´»ã€å·¥ä½œ)</label>
                        <input type="text" id="habit-l1" placeholder="è¾“å…¥åˆ†ç±»åç§°..." class="block w-full px-4 py-2 bg-orange-50 border border-orange-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-400 focus:border-transparent transition-all">
                    </div>
                    <div>
                        <label for="habit-l2" class="block text-sm font-medium text-orange-700 mb-1">å…·ä½“ä¹ æƒ¯ (ä¾‹å¦‚: æ™¨è·‘3å…¬é‡Œ)</label>
                        <input type="text" id="habit-l2" placeholder="è¾“å…¥ä¹ æƒ¯å†…å®¹..." class="block w-full px-4 py-2 bg-orange-50 border border-orange-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-400 focus:border-transparent transition-all">
                    </div>
                    <button id="btn-add-habit" class="w-full bg-orange-500 hover:bg-orange-600 text-white px-4 py-3 rounded-lg font-bold shadow-md hover:shadow-lg transition-all transform active:scale-95">
                        ç¡®è®¤æ·»åŠ 
                    </button>
                </div>
            </div>
            <div class="bg-white p-5 sm:p-6 rounded-xl shadow-sm border border-orange-100 mt-6">
                <h2 class="text-xl font-bold mb-4 text-orange-800">ğŸ“‹ å·²æ·»åŠ åˆ—è¡¨</h2>
                <p class="text-xs text-gray-500 mb-4">æç¤ºï¼šç‚¹å‡»ä¹ æƒ¯æ—è¾¹çš„ Ã— å¯åˆ é™¤è¯¥ä¹ æƒ¯ï¼ˆéœ€2æ¬¡ç¡®è®¤ï¼‰ã€‚</p>
                <div id="current-habits-list" class="space-y-3"></div>
            </div>
        </div>

        <!-- è§†å›¾: è®¾ç½®/æ•°æ®è¿ç§» -->
        <div id="view-settings" class="view">
            <div class="bg-white p-5 sm:p-6 rounded-xl shadow-sm border border-orange-100 space-y-6">
                
                <!-- 1. å¯¼å‡ºåˆ°æ—¥å† (V15 ä¿®å¤ç‰ˆ) -->
                <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                    <h3 class="font-bold text-green-800 mb-2 flex items-center">
                        ğŸ“… å¯¼å‡ºåˆ°æ‰‹æœºæ—¥å† (v15 æ ¼å¼ä¿®å¤)
                    </h3>
                    <p class="text-xs text-gray-600 mb-3">
                        ç”Ÿæˆæ ‡å‡†çš„æ—¥å†æ–‡ä»¶ã€‚å¦‚æœä¹‹å‰æç¤ºâ€œæ— æœ‰æ•ˆæ—¥ç¨‹â€ï¼Œè¯·ä½¿ç”¨æ­¤ç‰ˆæœ¬é‡æ–°ä¸‹è½½ã€‚
                    </p>
                    <button id="btn-export-ics" class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition-colors font-medium shadow-sm mb-3">
                        ä¸‹è½½æ—¥å†æ–‡ä»¶ (.ics)
                    </button>
                    
                    <!-- è°ƒè¯•é¢„è§ˆ -->
                    <label class="block text-xs font-bold text-green-700 mb-1">æ—¥å†æ–‡ä»¶å†…å®¹é¢„è§ˆ (è°ƒè¯•ç”¨):</label>
                    <textarea id="ics-preview" rows="4" readonly class="w-full border border-green-300 rounded-md p-2 text-xs bg-white text-gray-500" placeholder="ç‚¹å‡»ä¸Šæ–¹ä¸‹è½½æŒ‰é’®åï¼Œè¿™é‡Œä¼šæ˜¾ç¤ºç”Ÿæˆçš„å†…å®¹..."></textarea>
                </div>

                <hr class="border-gray-200">

                <!-- 2. æ•°æ®å¤‡ä»½ -->
                <div>
                    <h2 class="text-xl font-bold mb-4 text-orange-800">âš™ï¸ æ•°æ®å¤‡ä»½ä¸è¿ç§»</h2>
                    <div class="grid gap-6 md:grid-cols-2">
                        <!-- å¯¼å‡ºæ–‡æœ¬ -->
                        <div class="bg-orange-50 p-4 rounded-lg border border-orange-200">
                            <h3 class="font-bold text-orange-800 mb-2">ğŸ“¤ å¯¼å‡ºæ•°æ®ä»£ç </h3>
                            <button id="btn-export" class="w-full bg-orange-500 text-white py-2 rounded-lg hover:bg-orange-600 transition-colors font-medium mb-2">
                                å¤åˆ¶æ•°æ®ä»£ç 
                            </button>
                            <span id="export-status" class="text-xs text-green-600 font-bold hidden">âœ… å·²å¤åˆ¶ï¼</span>
                        </div>

                        <!-- å¯¼å…¥æ–‡æœ¬ -->
                        <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                            <h3 class="font-bold text-blue-800 mb-2">ğŸ“¥ å¯¼å…¥æ•°æ®ä»£ç </h3>
                            <textarea id="import-area" rows="2" class="w-full border border-gray-300 rounded-md p-2 text-xs mb-2 focus:ring-2 focus:ring-blue-400" placeholder="ç²˜è´´æ•°æ®ä»£ç ..."></textarea>
                            <button id="btn-import" class="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 transition-colors font-medium">
                                å¯¼å…¥å¹¶è¦†ç›–
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- æç¤ºæ¡† -->
    <div id="toast-message" class="hidden fixed top-8 left-1/2 -translate-x-1/2 bg-gradient-to-r from-orange-500 to-red-500 text-white px-8 py-3 rounded-full shadow-2xl z-50 text-center font-bold tracking-wide transform transition-all duration-300 scale-95 opacity-0">
    </div>

    <div id="fireworks-overlay" class="fireworks"></div>

    <!-- ç¡®è®¤æ¨¡æ€æ¡† -->
    <div id="confirm-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full transform transition-all scale-100">
            <h3 class="text-xl font-bold text-gray-800" id="modal-title">âš ï¸ ç¡®è®¤æ“ä½œ</h3>
            <p class="mt-3 text-sm text-gray-600 leading-relaxed" id="modal-text">ç¡®å®šæ‰§è¡Œï¼Ÿ</p>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="btn-modal-cancel" class="px-5 py-2 bg-gray-100 text-gray-700 rounded-xl font-medium hover:bg-gray-200 transition-colors">å–æ¶ˆ</button>
                <button id="btn-modal-confirm" class="px-5 py-2 bg-red-500 text-white rounded-xl font-medium hover:bg-red-600 shadow-md transition-colors">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const HABITS_KEY = 'habitTracker_habits_v2';
            const LOG_KEY = 'habitTracker_log_v2';
            
            const PASTEL_COLORS = ['#FFB3BA', '#FFDFBA', '#FFFFBA', '#BAFFC9', '#BAE1FF', '#E6B3FF', '#F0E68C'];

            let habits = [];
            let log = [];
            let chartInstance = null;
            let deleteActionState = { type: null, data: null, step: 0 }; 
            let resizeTimer = null; 

            // DOM Elements
            const navAdd = document.getElementById('nav-add');
            const navTrack = document.getElementById('nav-track');
            const navSettings = document.getElementById('nav-settings');
            const viewAdd = document.getElementById('view-add');
            const viewTrack = document.getElementById('view-track');
            const viewSettings = document.getElementById('view-settings');
            const habitL1Input = document.getElementById('habit-l1');
            const habitL2Input = document.getElementById('habit-l2');
            const btnAddHabit = document.getElementById('btn-add-habit');
            const currentHabitsList = document.getElementById('current-habits-list');
            const habitChecklistContainer = document.getElementById('habit-checklist-container');
            const dailyLogList = document.getElementById('daily-log-list');
            const monthlyStatsList = document.getElementById('monthly-stats-list');
            const chartCanvas = document.getElementById('daily-bar-chart');
            const chartBody = document.getElementById('chart-body'); 
            const zoomSlider = document.getElementById('zoom-slider');
            const toastMessage = document.getElementById('toast-message');
            const fireworksOverlay = document.getElementById('fireworks-overlay');
            const btnInitiateClearLogs = document.getElementById('btn-initiate-clear-logs');
            const confirmModal = document.getElementById('confirm-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalText = document.getElementById('modal-text');
            const btnModalCancel = document.getElementById('btn-modal-cancel');
            const btnModalConfirm = document.getElementById('btn-modal-confirm');
            const btnExport = document.getElementById('btn-export');
            const exportStatus = document.getElementById('export-status');
            const btnImport = document.getElementById('btn-import');
            const importArea = document.getElementById('import-area');
            const btnExportICS = document.getElementById('btn-export-ics');
            const icsPreview = document.getElementById('ics-preview');

            // Init
            loadData();
            renderAddHabitList();
            renderHabitChecklist();
            showView('view-track');

            // --- Functions ---
            function loadData() {
                try {
                    habits = JSON.parse(localStorage.getItem(HABITS_KEY)) || [];
                    log = JSON.parse(localStorage.getItem(LOG_KEY)) || [];
                } catch(e) { habits = []; log = []; }
            }
            function saveHabits() { localStorage.setItem(HABITS_KEY, JSON.stringify(habits)); }
            function saveLog() { localStorage.setItem(LOG_KEY, JSON.stringify(log)); }

            function showView(viewId) {
                [viewAdd, viewTrack, viewSettings].forEach(v => v.classList.remove('active'));
                const inactiveClass = 'nav-btn px-6 py-2 rounded-t-lg font-medium transition-all duration-200 text-gray-500 hover:text-orange-600 hover:bg-orange-50';
                const activeClass = 'nav-btn px-6 py-2 rounded-t-lg font-medium transition-all duration-200 bg-white text-orange-700 border-t border-x border-orange-200 shadow-sm';
                navAdd.className = inactiveClass; navTrack.className = inactiveClass;
                navSettings.classList.remove('text-orange-800', 'font-bold');

                if (viewId === 'view-add') { viewAdd.classList.add('active'); navAdd.className = activeClass; }
                else if (viewId === 'view-settings') { viewSettings.classList.add('active'); navSettings.classList.add('text-orange-800', 'font-bold'); }
                else { viewTrack.classList.add('active'); navTrack.className = activeClass; renderAllStats(); setTimeout(() => renderDailyChart(), 50); }
            }

            // --- Habits & Checklist ---
            function addHabit() {
                const l1 = habitL1Input.value.trim(); const l2 = habitL2Input.value.trim();
                if (l1 && l2) {
                    if (!habits.some(h => h.l1 === l1 && h.l2 === l2)) {
                        habits.push({ l1, l2 }); saveHabits();
                        habitL1Input.value = ''; habitL2Input.value = '';
                        renderAddHabitList(); renderHabitChecklist();
                        showToast('æ·»åŠ æˆåŠŸï¼', 'bg-green-500');
                    } else { showToast('ä¹ æƒ¯å·²å­˜åœ¨', 'bg-yellow-500'); }
                } else { showToast('è¯·å¡«å†™å®Œæ•´', 'bg-red-500'); }
            }
            
            function renderAddHabitList() {
                currentHabitsList.innerHTML = '';
                if (habits.length === 0) { currentHabitsList.innerHTML = '<p class="text-gray-400 text-sm italic p-2">æš‚æ— ä¹ æƒ¯ã€‚</p>'; return; }
                const grouped = groupHabits(habits);
                for (const l1 in grouped) {
                    const l1El = document.createElement('div'); l1El.className = 'mb-3 pb-3 border-b border-orange-50 last:border-0';
                    const l1Header = document.createElement('h4'); l1Header.className = 'font-bold text-orange-700 text-sm mb-2'; l1Header.textContent = l1;
                    l1El.appendChild(l1Header);
                    const l2List = document.createElement('div'); l2List.className = 'flex flex-wrap gap-2';
                    grouped[l1].forEach(habit => {
                        const l2Container = document.createElement('div'); l2Container.className = 'flex items-center bg-orange-100 text-orange-900 text-sm px-3 py-1.5 rounded-lg border border-orange-200 shadow-sm';
                        const l2Text = document.createElement('span'); l2Text.textContent = habit.l2; l2Text.className = 'mr-2 font-medium';
                        const delBtn = document.createElement('button'); delBtn.innerHTML = '&times;'; delBtn.className = 'delete-habit-btn w-5 h-5 flex items-center justify-center rounded-full bg-orange-200 text-orange-700 text-lg leading-none transition-colors';
                        delBtn.onclick = (e) => { e.stopPropagation(); initiateDeleteHabit(habit.l1, habit.l2); };
                        l2Container.appendChild(l2Text); l2Container.appendChild(delBtn); l2List.appendChild(l2Container);
                    });
                    l1El.appendChild(l2List); currentHabitsList.appendChild(l1El);
                }
            }

            function groupHabits(arr) { if (!Array.isArray(arr)) return {}; return arr.reduce((acc, h) => { if(h && h.l1) { if (!acc[h.l1]) acc[h.l1] = []; acc[h.l1].push(h); } return acc; }, {}); }

            function renderHabitChecklist() {
                habitChecklistContainer.innerHTML = '';
                if (habits.length === 0) { habitChecklistContainer.innerHTML = '<div class="text-center py-8 text-gray-400">æš‚æ— ä¹ æƒ¯</div>'; return; }
                const grouped = groupHabits(habits);
                for (const l1 in grouped) {
                    const l1Group = document.createElement('div'); l1Group.className = 'border border-orange-100 rounded-lg overflow-hidden mb-3';
                    const l1Header = document.createElement('div'); l1Header.className = 'flex justify-between items-center p-3 bg-orange-50 cursor-pointer hover:bg-orange-100 transition-colors select-none';
                    l1Header.innerHTML = `<h3 class="font-bold text-orange-800">${l1}</h3><span class="text-orange-400 text-xs transform transition-transform duration-200">â–¼</span>`;
                    const l2Container = document.createElement('div'); l2Container.className = 'p-3 bg-white space-y-3';
                    grouped[l1].forEach(habit => {
                        const habitEl = document.createElement('div'); habitEl.className = 'flex items-center space-x-3 group cursor-pointer p-2 rounded-lg hover:bg-orange-50 transition-all';
                        const checkbox = document.createElement('div'); checkbox.className = 'w-6 h-6 border-2 border-orange-300 rounded-md flex items-center justify-center text-white bg-white group-hover:border-orange-400 transition-all shadow-sm';
                        habitEl.onclick = (e) => { if(habitEl.dataset.clicking) return; habitEl.dataset.clicking = "true"; checkbox.classList.add('bg-orange-500', 'border-orange-500'); checkbox.innerHTML = 'âœ“'; checkIn(habit.l2); setTimeout(() => { checkbox.classList.remove('bg-orange-500', 'border-orange-500'); checkbox.innerHTML = ''; delete habitEl.dataset.clicking; }, 300); };
                        const name = document.createElement('span'); name.className = 'text-gray-700 font-medium select-none'; name.textContent = habit.l2;
                        habitEl.appendChild(checkbox); habitEl.appendChild(name); l2Container.appendChild(habitEl);
                    });
                    l1Header.onclick = () => { if (l2Container.style.display === 'none') { l2Container.style.display = 'block'; l1Header.querySelector('span').classList.remove('-rotate-90'); } else { l2Container.style.display = 'none'; l1Header.querySelector('span').classList.add('-rotate-90'); } };
                    l1Group.appendChild(l1Header); l1Group.appendChild(l2Container); habitChecklistContainer.appendChild(l1Group);
                }
            }

            function checkIn(name) { log.push({ habit: name, time: Date.now() }); saveLog(); showFeedback(name); renderAllStats(); }
            
            function showFeedback(name) {
                toastMessage.textContent = `å·²å®Œæˆ: ${name}`; toastMessage.classList.remove('hidden', 'scale-95', 'opacity-0'); toastMessage.classList.add('scale-100', 'opacity-100');
                fireworksOverlay.classList.add('active'); createFireworks(30);
                setTimeout(() => { fireworksOverlay.classList.remove('active'); fireworksOverlay.innerHTML = ''; }, 300);
                setTimeout(() => { toastMessage.classList.remove('scale-100', 'opacity-100'); toastMessage.classList.add('scale-95', 'opacity-0'); setTimeout(() => toastMessage.classList.add('hidden'), 300); }, 1300);
            }
            
            function showToast(msg, bgClass) { const el = document.createElement('div'); el.className = `fixed top-20 left-1/2 -translate-x-1/2 ${bgClass || 'bg-gray-700'} text-white px-4 py-2 rounded-lg shadow-lg z-50 text-sm transition-opacity duration-500 opacity-0`; el.textContent = msg; document.body.appendChild(el); requestAnimationFrame(() => el.classList.remove('opacity-0')); setTimeout(() => { el.classList.add('opacity-0'); setTimeout(() => el.remove(), 500); }, 2000); }

            function createFireworks(count) { for (let i = 0; i < count; i++) { const f = document.createElement('div'); f.className = 'firework'; f.style.top = `${20+Math.random()*60}vh`; f.style.left = `${20+Math.random()*60}vw`; const angle = Math.random() * Math.PI * 2; const dist = 100 + Math.random() * 150; f.style.setProperty('--tx', `${Math.cos(angle)*dist}px`); f.style.setProperty('--ty', `${Math.sin(angle)*dist}px`); f.style.backgroundColor = `hsl(${Math.random()*360}, 80%, 60%)`; fireworksOverlay.appendChild(f); } }
            
            function getFormattedDate(ts) { const d = new Date(ts); return `${d.getFullYear()}.${d.getMonth()+1}.${d.getDate()}`; }

            function renderAllStats() { renderDailyLog(); renderMonthlyStats(); renderDailyChart(); }

            function renderDailyLog() {
                dailyLogList.innerHTML = ''; const todayStr = getFormattedDate(Date.now()); const todayLog = log.filter(e => getFormattedDate(e.time) === todayStr);
                if (todayLog.length === 0) { dailyLogList.innerHTML = '<div class="text-gray-400 text-sm italic text-center py-4">ä»Šå¤©è¿˜æ²¡æœ‰æ‰“å¡å“¦</div>'; return; }
                const grouped = todayLog.reduce((acc, e) => { if (!acc[e.habit]) acc[e.habit] = []; acc[e.habit].push(e.time); return acc; }, {});
                for (const name in grouped) {
                    const times = grouped[name]; const count = times.length;
                    const logEl = document.createElement('div'); logEl.className = 'bg-orange-50 rounded-lg p-2';
                    const header = document.createElement('div'); header.className = 'flex items-center justify-between';
                    const left = document.createElement('div'); left.className = 'flex items-center space-x-2';
                    const nEl = document.createElement('span'); nEl.className = 'font-semibold text-orange-900'; nEl.textContent = name;
                    left.appendChild(nEl);
                    if (count > 0) { const cEl = document.createElement('span'); cEl.className = 'text-xs font-bold bg-white text-orange-600 border border-orange-200 px-2 py-0.5 rounded-full'; cEl.textContent = `${count}æ¬¡`; left.appendChild(cEl); }
                    header.appendChild(left);
                    if (count > 1) { header.classList.add('cursor-pointer'); const h = document.createElement('span'); h.className = 'text-xs text-orange-400'; h.textContent = 'å±•å¼€'; header.appendChild(h); } 
                    else { const t = document.createElement('span'); t.className = 'text-xs text-orange-500'; t.textContent = new Date(times[0]).toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'}); header.appendChild(t); }
                    logEl.appendChild(header);
                    if (count > 1) {
                        const list = document.createElement('ul'); list.className = 'hidden mt-2 space-y-1 pl-2 border-l-2 border-orange-200';
                        times.forEach(t => { const li = document.createElement('li'); li.className = 'text-xs text-gray-600'; li.textContent = new Date(t).toLocaleTimeString('zh-CN'); list.appendChild(li); });
                        header.onclick = () => list.classList.toggle('hidden'); logEl.appendChild(list);
                    }
                    dailyLogList.appendChild(logEl);
                }
            }

            function renderMonthlyStats() {
                monthlyStatsList.innerHTML = ''; const now = new Date(); const mLog = log.filter(e => { const d = new Date(e.time); return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear(); });
                if (mLog.length === 0) { monthlyStatsList.innerHTML = '<div class="text-gray-400 text-sm italic text-center py-4">æœ¬æœˆæš‚æ— æ•°æ®</div>'; return; }
                const grouped = mLog.reduce((acc, e) => { acc[e.habit] = (acc[e.habit]||0)+1; return acc; }, {});
                Object.entries(grouped).sort((a,b)=>b[1]-a[1]).forEach(([name, count], idx) => {
                    const div = document.createElement('div'); div.className = 'flex items-center p-2 hover:bg-orange-50 rounded-lg transition-colors';
                    let badge = 'bg-gray-100 text-gray-600'; if(idx===0) badge='bg-yellow-100 text-yellow-700'; else if(idx===1) badge='bg-gray-200 text-gray-700'; else if(idx===2) badge='bg-orange-100 text-orange-700';
                    div.innerHTML = `<div class="flex items-center flex-1"><span class="w-6 h-6 flex items-center justify-center rounded-full text-xs mr-3 ${badge} font-bold">${idx+1}</span><span class="text-gray-800 font-medium">${name}</span></div><span class="font-bold text-orange-600 text-sm">${count} æ¬¡</span>`;
                    monthlyStatsList.appendChild(div);
                });
            }

            function renderDailyChart() {
                if (!chartCanvas) return;
                const grouped = log.reduce((acc, e) => { const d = getFormattedDate(e.time); acc[d] = (acc[d]||0)+1; return acc; }, {});
                const sorted = Object.entries(grouped).sort((a,b) => { const pa=a[0].split('.').map(Number); const pb=b[0].split('.').map(Number); return new Date(pa[0],pa[1]-1,pa[2]) - new Date(pb[0],pb[1]-1,pb[2]); });
                const labels = sorted.map(e => e[0]); const data = sorted.map(e => e[1]);
                const barW = parseInt(zoomSlider.value); const w = Math.max(chartBody.parentElement.clientWidth, labels.length * (barW*1.5) + 50);
                chartBody.style.width = `${w}px`;
                if (chartInstance) chartInstance.destroy();
                if (labels.length === 0) return;
                chartInstance = new Chart(chartCanvas.getContext('2d'), {
                    type: 'bar',
                    data: { labels: labels, datasets: [{ label: 'æ‰“å¡æ•°', data: data, backgroundColor: data.map((_, i) => PASTEL_COLORS[i % 7]), borderRadius: 4, barThickness: barW }] },
                    options: { responsive: true, maintainAspectRatio: false, layout: { padding: { left: 10, right: 10, top: 20 } }, scales: { x: { grid: { display: false }, ticks: { font: { size: 11 } } }, y: { display: false, beginAtZero: true } }, plugins: { legend: { display: false } } }
                });
                if (w > chartBody.parentElement.clientWidth) chartBody.parentElement.scrollLeft = chartBody.parentElement.scrollWidth;
            }

            // --- Export/Import ---
            btnExport.addEventListener('click', () => {
                const d = JSON.stringify({ habits, log, version: 'v10' });
                navigator.clipboard.writeText(d).then(() => { exportStatus.classList.remove('hidden'); setTimeout(() => exportStatus.classList.add('hidden'), 3000); }).catch(console.error);
            });
            btnImport.addEventListener('click', () => {
                try {
                    const d = JSON.parse(importArea.value.trim());
                    if (Array.isArray(d.habits) && Array.isArray(d.log)) {
                        if (confirm('ç¡®å®šè¦†ç›–å½“å‰æ•°æ®å—ï¼Ÿ')) { habits = d.habits; log = d.log; saveHabits(); saveLog(); showToast('å¯¼å…¥æˆåŠŸ', 'bg-green-500'); importArea.value=''; renderAddHabitList(); renderHabitChecklist(); showView('view-track'); }
                    } else showToast('æ ¼å¼é”™è¯¯', 'bg-red-500');
                } catch(e) { showToast('ä»£ç æ— æ•ˆ', 'bg-red-500'); }
            });

            // --- ICS Logic (V15 FIX: String Concatenation) ---
            const formatICSDateUTC = (d) => {
                const pad = n => n < 10 ? '0'+n : ''+n; // FORCE STRING RETURN
                // Ensure all parts are strings before joining
                return d.getUTCFullYear() + 
                       pad(d.getUTCMonth() + 1) + 
                       pad(d.getUTCDate()) + 'T' + 
                       pad(d.getUTCHours()) + 
                       pad(d.getUTCMinutes()) + 
                       pad(d.getUTCSeconds()) + 'Z';
            };

            btnExportICS.addEventListener('click', () => {
                if (log.length === 0) { showToast('æ— æ‰“å¡è®°å½•', 'bg-yellow-500'); return; }
                
                const CRLF = '\r\n';
                const nowStr = formatICSDateUTC(new Date());
                
                let ics = [
                    'BEGIN:VCALENDAR',
                    'VERSION:2.0',
                    'PRODID:-//HabitTrackerPro//CN',
                    'CALSCALE:GREGORIAN',
                    'METHOD:PUBLISH'
                ].join(CRLF) + CRLF;

                log.forEach((entry, idx) => {
                    const d = new Date(entry.time);
                    const dtStart = formatICSDateUTC(d);
                    const e = new Date(d.getTime() + 15 * 60000); 
                    const dtEnd = formatICSDateUTC(e);
                    const uid = `habit-${entry.time}-${idx}@tracker`;

                    const event = [
                        'BEGIN:VEVENT',
                        `UID:${uid}`,
                        `DTSTAMP:${nowStr}`,
                        `DTSTART:${dtStart}`,
                        `DTEND:${dtEnd}`,
                        `SUMMARY:âœ… ${entry.habit}`,
                        'END:VEVENT'
                    ].join(CRLF);
                    ics += event + CRLF;
                });

                ics += 'END:VCALENDAR';
                
                icsPreview.value = ics;

                const blob = new Blob([ics], { type: 'text/calendar;charset=utf-8' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'habit_log.ics';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });

            // --- Delete Logic ---
            function initiateClearLogs() { deleteActionState = { type: 'LOGS', step: 1 }; modalTitle.textContent = 'âš ï¸ ç¡®è®¤æ¸…ç©º'; modalText.innerHTML = 'æ¸…ç©ºæ‰€æœ‰è®°å½•ï¼Ÿ'; btnModalConfirm.textContent = 'ç¡®å®š'; confirmModal.classList.remove('hidden'); }
            function initiateDeleteHabit(l1, l2) { deleteActionState = { type: 'HABIT', step: 1, data: {l1,l2} }; modalTitle.textContent = 'âš ï¸ ç¡®è®¤åˆ é™¤'; modalText.innerHTML = `åˆ é™¤ä¹ æƒ¯ "${l2}"?`; btnModalConfirm.textContent = 'ç¡®å®š'; confirmModal.classList.remove('hidden'); }
            function cancelModal() { deleteActionState = { type: null, step: 0 }; confirmModal.classList.add('hidden'); btnModalConfirm.classList.remove('animate-pulse'); }
            function confirmModalAction() {
                const { type, step, data } = deleteActionState;
                if (type === 'LOGS') {
                    if (step === 1) { deleteActionState.step = 2; modalText.innerHTML = 'æœ€åè­¦å‘Šï¼šä¸å¯æ¢å¤ï¼'; btnModalConfirm.textContent = 'åˆ é™¤'; btnModalConfirm.classList.add('animate-pulse'); }
                    else { log = []; saveLog(); renderAllStats(); cancelModal(); showToast('å·²æ¸…ç©º', 'bg-gray-600'); }
                } else if (type === 'HABIT') {
                    if (step === 1) { deleteActionState.step = 2; modalText.innerHTML = 'æœ€åè­¦å‘Šï¼šå°†æ°¸ä¹…ç§»é™¤ã€‚'; btnModalConfirm.textContent = 'åˆ é™¤'; btnModalConfirm.classList.add('animate-pulse'); }
                    else { habits = habits.filter(h => !(h.l1===data.l1 && h.l2===data.l2)); saveHabits(); renderAddHabitList(); renderHabitChecklist(); cancelModal(); showToast('å·²åˆ é™¤', 'bg-gray-600'); }
                }
            }

            // Restored Listeners
            navAdd.addEventListener('click', () => showView('view-add'));
            navTrack.addEventListener('click', () => showView('view-track'));
            navSettings.addEventListener('click', () => showView('view-settings'));
            btnAddHabit.addEventListener('click', addHabit);
            btnInitiateClearLogs.addEventListener('click', initiateClearLogs);
            btnModalCancel.addEventListener('click', cancelModal);
            btnModalConfirm.addEventListener('click', confirmModalAction);
            zoomSlider.addEventListener('input', () => renderDailyChart());
            window.addEventListener('resize', () => { 
                clearTimeout(resizeTimer); 
                resizeTimer = setTimeout(() => { 
                    if (viewTrack.classList.contains('active')) renderDailyChart(); 
                }, 200); 
            });
        });
    </script>
</body>
</html>
