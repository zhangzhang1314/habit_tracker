<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¹ æƒ¯æ‰“å¡ Pro v8 (iOSæ—¥å†ä¿®å¤ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Chosen Palette: Warm Neutrals with Pastel Accents -->
    <!-- Application Structure Plan:
         1. Views: Track, Add, Settings.
         2. Fix: ICS generation now uses CRLF (\r\n) line endings required by iOS Calendar.
         3. Fix: Added METHOD:PUBLISH and proper UTC formatting for DTSTAMP to ensure compatibility.
         4. Preserved: All previous features (Data sync, Delete confirm, Fireworks).
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        .hidden { display: none; }
        .view { display: none; }
        .view.active { display: block; }
        
        /* çƒŸèŠ±å®¹å™¨ */
        .fireworks {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.1);
            z-index: 100;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.1s ease-out;
        }
        .fireworks.active {
            opacity: 1;
            transition: opacity 0.05s ease-in;
        }
        .firework {
            position: absolute;
            width: 4px;
            height: 4px;
            background-color: #fff;
            border-radius: 50%;
            opacity: 0;
            animation: burst 0.3s ease-out forwards;
        }
        @keyframes burst {
            0% { transform: scale(0); opacity: 1; }
            100% { transform: scale(2.5) translate(var(--tx), var(--ty)); opacity: 0; }
        }

        /* å›¾è¡¨å®¹å™¨ */
        .chart-scroll-wrapper {
            width: 100%;
            overflow-x: auto;
            scrollbar-width: thin;
            scrollbar-color: #fb923c #fff7ed;
        }
        .chart-body {
            position: relative;
            height: 350px;
        }
        
        .delete-habit-btn:hover {
            background-color: #fecaca;
            color: #dc2626;
        }
        
        textarea {
            font-family: monospace;
        }
    </style>
</head>
<body class="bg-orange-50 text-orange-900 font-sans min-h-screen">

    <div class="max-w-4xl mx-auto p-4 sm:p-6 pb-20">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl sm:text-3xl font-bold text-orange-800 tracking-wide">ä¹ æƒ¯æ‰“å¡ Pro</h1>
            <button id="nav-settings" class="text-sm text-orange-600 underline hover:text-orange-800">âš™ï¸ è®¾ç½®/æ—¥å†</button>
        </div>

        <!-- å¯¼èˆª -->
        <div class="flex justify-center space-x-4 mb-6 border-b border-orange-200 pb-2">
            <button id="nav-track" class="nav-btn px-6 py-2 rounded-t-lg font-medium transition-all duration-200">æ‰“å¡ & ç»Ÿè®¡</button>
            <button id="nav-add" class="nav-btn px-6 py-2 rounded-t-lg font-medium transition-all duration-200">æ·»åŠ ä¹ æƒ¯</button>
        </div>

        <!-- è§†å›¾: æ‰“å¡ä¸ç»Ÿè®¡ -->
        <div id="view-track" class="view active space-y-8">
            <div class="bg-white p-5 sm:p-6 rounded-xl shadow-sm border border-orange-100">
                <h2 class="text-xl font-bold mb-4 text-orange-800 flex items-center">
                    <span class="mr-2">ğŸ“</span> ä»Šæ—¥ä¹ æƒ¯
                </h2>
                <div id="habit-checklist-container" class="space-y-4"></div>
            </div>

            <div class="bg-white p-5 sm:p-6 rounded-xl shadow-sm border border-orange-100 relative">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-orange-800 flex items-center">
                        <span class="mr-2">ğŸ“…</span> æ‰“å¡æ—¥å¿— (ä»Šæ—¥)
                    </h2>
                    <button id="btn-initiate-clear-logs" class="bg-red-100 text-red-600 px-3 py-1.5 rounded-lg text-xs font-semibold hover:bg-red-200 transition-colors">
                        æ¸…ç©ºæ•°æ®
                    </button>
                </div>
                <div id="daily-log-list" class="space-y-2 max-h-60 overflow-y-auto"></div>
            </div>

            <div class="bg-white p-5 sm:p-6 rounded-xl shadow-sm border border-orange-100">
                <h2 class="text-xl font-bold mb-4 text-orange-800 flex items-center">
                    <span class="mr-2">ğŸ†</span> æœˆåº¦æ’è¡Œ (æœ¬æœˆ)
                </h2>
                <div id="monthly-stats-list" class="space-y-2"></div>
            </div>

            <div class="bg-white p-5 sm:p-6 rounded-xl shadow-sm border border-orange-100">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                    <h2 class="text-xl font-bold text-orange-800 flex items-center">
                        <span class="mr-2">ğŸ“Š</span> æ¯æ—¥ç»Ÿè®¡
                    </h2>
                    <div class="flex items-center space-x-2 mt-2 sm:mt-0 bg-orange-50 px-3 py-1 rounded-full">
                        <span class="text-xs text-orange-600">è§†è§’:</span>
                        <span class="text-xs">â–</span>
                        <input type="range" id="zoom-slider" min="30" max="150" value="60" class="w-24 h-2 bg-orange-200 rounded-lg appearance-none cursor-pointer accent-orange-500">
                        <span class="text-xs">â•</span>
                    </div>
                </div>
                <div class="chart-scroll-wrapper border-t border-orange-50 pt-4">
                    <div class="chart-body" id="chart-body">
                        <canvas id="daily-bar-chart"></canvas>
                    </div>
                </div>
                <p class="text-center text-xs text-gray-400 mt-2">â† å·¦å³æ»‘åŠ¨æŸ¥çœ‹æ›´å¤šæ—¥æœŸ â†’</p>
            </div>
        </div>

        <!-- è§†å›¾: æ·»åŠ ä¹ æƒ¯ -->
        <div id="view-add" class="view">
            <div class="bg-white p-5 sm:p-6 rounded-xl shadow-sm border border-orange-100">
                <h2 class="text-xl font-bold mb-4 text-orange-800">â• æ·»åŠ æ–°ä¹ æƒ¯</h2>
                <div class="space-y-4">
                    <div>
                        <label for="habit-l1" class="block text-sm font-medium text-orange-700 mb-1">ä¸€çº§åˆ†ç±» (ä¾‹å¦‚: ç”Ÿæ´»ã€å·¥ä½œ)</label>
                        <input type="text" id="habit-l1" placeholder="è¾“å…¥åˆ†ç±»åç§°..." class="block w-full px-4 py-2 bg-orange-50 border border-orange-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-400 focus:border-transparent transition-all">
                    </div>
                    <div>
                        <label for="habit-l2" class="block text-sm font-medium text-orange-700 mb-1">å…·ä½“ä¹ æƒ¯ (ä¾‹å¦‚: æ™¨è·‘3å…¬é‡Œ)</label>
                        <input type="text" id="habit-l2" placeholder="è¾“å…¥ä¹ æƒ¯å†…å®¹..." class="block w-full px-4 py-2 bg-orange-50 border border-orange-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-400 focus:border-transparent transition-all">
                    </div>
                    <button id="btn-add-habit" class="w-full bg-orange-500 hover:bg-orange-600 text-white px-4 py-3 rounded-lg font-bold shadow-md hover:shadow-lg transition-all transform active:scale-95">
                        ç¡®è®¤æ·»åŠ 
                    </button>
                </div>
            </div>
            <div class="bg-white p-5 sm:p-6 rounded-xl shadow-sm border border-orange-100 mt-6">
                <h2 class="text-xl font-bold mb-4 text-orange-800">ğŸ“‹ å·²æ·»åŠ åˆ—è¡¨</h2>
                <p class="text-xs text-gray-500 mb-4">æç¤ºï¼šç‚¹å‡»ä¹ æƒ¯æ—è¾¹çš„ Ã— å¯åˆ é™¤è¯¥ä¹ æƒ¯ï¼ˆéœ€2æ¬¡ç¡®è®¤ï¼‰ã€‚</p>
                <div id="current-habits-list" class="space-y-3"></div>
            </div>
        </div>

        <!-- è§†å›¾: è®¾ç½®/æ•°æ®è¿ç§» -->
        <div id="view-settings" class="view">
            <div class="bg-white p-5 sm:p-6 rounded-xl shadow-sm border border-orange-100 space-y-6">
                
                <!-- 1. å¯¼å‡ºåˆ°æ—¥å† (ä¿®å¤ç‰ˆ) -->
                <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                    <h3 class="font-bold text-green-800 mb-2 flex items-center">
                        ğŸ“… å¯¼å‡ºåˆ°æ‰‹æœºæ—¥å† (ä¿®å¤ç‰ˆ)
                    </h3>
                    <p class="text-xs text-gray-600 mb-3">
                        å°†æ‰“å¡è®°å½•ç”Ÿæˆæ ‡å‡†æ—¥å†æ–‡ä»¶ã€‚æ”¯æŒ iPhone æ—¥å†å®Œç¾å¯¼å…¥ã€‚
                    </p>
                    <button id="btn-export-ics" class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition-colors font-medium shadow-sm">
                        ä¸‹è½½æ—¥å†æ–‡ä»¶ (.ics)
                    </button>
                </div>

                <hr class="border-gray-200">

                <!-- 2. æ•°æ®å¤‡ä»½ -->
                <div>
                    <h2 class="text-xl font-bold mb-4 text-orange-800">âš™ï¸ æ•°æ®å¤‡ä»½ä¸è¿ç§»</h2>
                    <div class="grid gap-6 md:grid-cols-2">
                        <!-- å¯¼å‡ºæ–‡æœ¬ -->
                        <div class="bg-orange-50 p-4 rounded-lg border border-orange-200">
                            <h3 class="font-bold text-orange-800 mb-2">ğŸ“¤ å¯¼å‡ºæ•°æ®ä»£ç </h3>
                            <p class="text-xs text-gray-500 mb-2">ç”¨äºåœ¨ä¸åŒæµè§ˆå™¨é—´æ‰‹åŠ¨è½¬ç§»æ•°æ®ã€‚</p>
                            <button id="btn-export" class="w-full bg-orange-500 text-white py-2 rounded-lg hover:bg-orange-600 transition-colors font-medium mb-2">
                                å¤åˆ¶æ•°æ®ä»£ç 
                            </button>
                            <span id="export-status" class="text-xs text-green-600 font-bold hidden">âœ… å·²å¤åˆ¶ï¼</span>
                        </div>

                        <!-- å¯¼å…¥æ–‡æœ¬ -->
                        <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                            <h3 class="font-bold text-blue-800 mb-2">ğŸ“¥ å¯¼å…¥æ•°æ®ä»£ç </h3>
                            <p class="text-xs text-gray-500 mb-2">ç²˜è´´ä»£ç è¦†ç›–å½“å‰è®°å½•ã€‚</p>
                            <textarea id="import-area" rows="2" class="w-full border border-gray-300 rounded-md p-2 text-xs mb-2 focus:ring-2 focus:ring-blue-400" placeholder="ç²˜è´´æ•°æ®ä»£ç ..."></textarea>
                            <button id="btn-import" class="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 transition-colors font-medium">
                                å¯¼å…¥å¹¶è¦†ç›–
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- æç¤ºæ¡† -->
    <div id="toast-message" class="hidden fixed top-8 left-1/2 -translate-x-1/2 bg-gradient-to-r from-orange-500 to-red-500 text-white px-8 py-3 rounded-full shadow-2xl z-50 text-center font-bold tracking-wide transform transition-all duration-300 scale-95 opacity-0">
    </div>

    <!-- çƒŸèŠ±é®ç½© -->
    <div id="fireworks-overlay" class="fireworks"></div>

    <!-- ç¡®è®¤æ¨¡æ€æ¡† -->
    <div id="confirm-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full transform transition-all scale-100">
            <h3 class="text-xl font-bold text-gray-800" id="modal-title">âš ï¸ ç¡®è®¤æ“ä½œ</h3>
            <p class="mt-3 text-sm text-gray-600 leading-relaxed" id="modal-text">æ‚¨ç¡®å®šè¦æ‰§è¡Œæ­¤æ“ä½œå—ï¼Ÿ</p>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="btn-modal-cancel" class="px-5 py-2 bg-gray-100 text-gray-700 rounded-xl font-medium hover:bg-gray-200 transition-colors">å–æ¶ˆ</button>
                <button id="btn-modal-confirm" class="px-5 py-2 bg-red-500 text-white rounded-xl font-medium hover:bg-red-600 shadow-md transition-colors">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Init Constants ---
            const HABITS_KEY = 'habitTracker_habits_v2';
            const LOG_KEY = 'habitTracker_log_v2';
            
            const PASTEL_COLORS = [
                '#FFB3BA', '#FFDFBA', '#FFFFBA', '#BAFFC9', 
                '#BAE1FF', '#E6B3FF', '#F0E68C'
            ];

            let habits = [];
            let log = [];
            let chartInstance = null;
            let deleteActionState = { type: null, data: null, step: 0 }; 

            // --- DOM Elements ---
            const navAdd = document.getElementById('nav-add');
            const navTrack = document.getElementById('nav-track');
            const navSettings = document.getElementById('nav-settings');
            
            const viewAdd = document.getElementById('view-add');
            const viewTrack = document.getElementById('view-track');
            const viewSettings = document.getElementById('view-settings');

            const habitL1Input = document.getElementById('habit-l1');
            const habitL2Input = document.getElementById('habit-l2');
            const btnAddHabit = document.getElementById('btn-add-habit');
            const currentHabitsList = document.getElementById('current-habits-list');
            
            const habitChecklistContainer = document.getElementById('habit-checklist-container');
            const dailyLogList = document.getElementById('daily-log-list');
            const monthlyStatsList = document.getElementById('monthly-stats-list');
            
            const chartCanvas = document.getElementById('daily-bar-chart');
            const chartBody = document.getElementById('chart-body');
            const zoomSlider = document.getElementById('zoom-slider');

            const toastMessage = document.getElementById('toast-message');
            const fireworksOverlay = document.getElementById('fireworks-overlay');
            
            const btnInitiateClearLogs = document.getElementById('btn-initiate-clear-logs');
            const confirmModal = document.getElementById('confirm-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalText = document.getElementById('modal-text');
            const btnModalCancel = document.getElementById('btn-modal-cancel');
            const btnModalConfirm = document.getElementById('btn-modal-confirm');

            const btnExport = document.getElementById('btn-export');
            const exportStatus = document.getElementById('export-status');
            const btnImport = document.getElementById('btn-import');
            const importArea = document.getElementById('import-area');
            const btnExportICS = document.getElementById('btn-export-ics');

            // --- Init ---
            loadData();
            renderAddHabitList();
            renderHabitChecklist();
            showView('view-track');

            // --- Functions ---
            function loadData() {
                try {
                    habits = JSON.parse(localStorage.getItem(HABITS_KEY)) || [];
                    log = JSON.parse(localStorage.getItem(LOG_KEY)) || [];
                } catch(e) {
                    habits = [];
                    log = [];
                }
            }

            function saveHabits() {
                localStorage.setItem(HABITS_KEY, JSON.stringify(habits));
            }

            function saveLog() {
                localStorage.setItem(LOG_KEY, JSON.stringify(log));
            }

            function showView(viewId) {
                [viewAdd, viewTrack, viewSettings].forEach(v => v.classList.remove('active'));
                
                const inactiveClass = 'nav-btn px-6 py-2 rounded-t-lg font-medium transition-all duration-200 text-gray-500 hover:text-orange-600 hover:bg-orange-50';
                const activeClass = 'nav-btn px-6 py-2 rounded-t-lg font-medium transition-all duration-200 bg-white text-orange-700 border-t border-x border-orange-200 shadow-sm';
                
                navAdd.className = inactiveClass;
                navTrack.className = inactiveClass;
                navSettings.classList.remove('text-orange-800', 'font-bold');

                if (viewId === 'view-add') {
                    viewAdd.classList.add('active');
                    navAdd.className = activeClass;
                } else if (viewId === 'view-settings') {
                    viewSettings.classList.add('active');
                    navSettings.classList.add('text-orange-800', 'font-bold');
                } else {
                    viewTrack.classList.add('active');
                    navTrack.className = activeClass;
                    renderAllStats();
                    setTimeout(() => renderDailyChart(), 50); 
                }
            }

            // --- Habits ---
            function addHabit() {
                const l1 = habitL1Input.value.trim();
                const l2 = habitL2Input.value.trim();
                if (l1 && l2) {
                    if (!habits.some(h => h.l1 === l1 && h.l2 === l2)) {
                        habits.push({ l1, l2 });
                        saveHabits();
                        habitL1Input.value = '';
                        habitL2Input.value = '';
                        renderAddHabitList();
                        renderHabitChecklist();
                        showToast('æ·»åŠ æˆåŠŸï¼', 'bg-green-500');
                    } else {
                        showToast('è¿™ä¸ªä¹ æƒ¯å·²ç»å­˜åœ¨äº†', 'bg-yellow-500');
                    }
                } else {
                    showToast('è¯·å®Œæ•´å¡«å†™åˆ†ç±»å’Œå†…å®¹', 'bg-red-500');
                }
            }
            
            function renderAddHabitList() {
                currentHabitsList.innerHTML = '';
                if (habits.length === 0) {
                    currentHabitsList.innerHTML = '<p class="text-gray-400 text-sm italic p-2">æš‚æ— ä¹ æƒ¯ï¼Œè¯·åœ¨ä¸Šæ–¹æ·»åŠ ã€‚</p>';
                    return;
                }
                const grouped = groupHabits(habits);
                for (const l1 in grouped) {
                    const l1El = document.createElement('div');
                    l1El.className = 'mb-3 pb-3 border-b border-orange-50 last:border-0';
                    
                    const l1Header = document.createElement('h4');
                    l1Header.className = 'font-bold text-orange-700 text-sm mb-2';
                    l1Header.textContent = l1;
                    l1El.appendChild(l1Header);
                    
                    const l2List = document.createElement('div');
                    l2List.className = 'flex flex-wrap gap-2';
                    
                    grouped[l1].forEach(habit => {
                        const l2Container = document.createElement('div');
                        l2Container.className = 'flex items-center bg-orange-100 text-orange-900 text-sm px-3 py-1.5 rounded-lg border border-orange-200 shadow-sm';
                        
                        const l2Text = document.createElement('span');
                        l2Text.textContent = habit.l2;
                        l2Text.className = 'mr-2 font-medium';
                        
                        const delBtn = document.createElement('button');
                        delBtn.innerHTML = '&times;';
                        delBtn.title = 'åˆ é™¤æ­¤ä¹ æƒ¯';
                        delBtn.className = 'delete-habit-btn w-5 h-5 flex items-center justify-center rounded-full bg-orange-200 text-orange-700 text-lg leading-none transition-colors';
                        
                        delBtn.onclick = (e) => {
                            e.stopPropagation();
                            initiateDeleteHabit(habit.l1, habit.l2);
                        };
                        
                        l2Container.appendChild(l2Text);
                        l2Container.appendChild(delBtn);
                        l2List.appendChild(l2Container);
                    });
                    
                    l1El.appendChild(l2List);
                    currentHabitsList.appendChild(l1El);
                }
            }

            function groupHabits(habitsArray) {
                if (!Array.isArray(habitsArray)) return {};
                return habitsArray.reduce((acc, habit) => {
                    if (habit && habit.l1) {
                        if (!acc[habit.l1]) {
                            acc[habit.l1] = [];
                        }
                        acc[habit.l1].push(habit);
                    }
                    return acc;
                }, {});
            }

            // --- Check-in & Stats ---
            function renderHabitChecklist() {
                habitChecklistContainer.innerHTML = '';
                if (habits.length === 0) {
                    habitChecklistContainer.innerHTML = '<div class="text-center py-8 text-gray-400">ğŸ‘‹ è¿˜æ²¡æœ‰ä¹ æƒ¯ï¼Œå»"æ·»åŠ ä¹ æƒ¯"é¡µé¢æ–°å»ºä¸€ä¸ªå§ï¼</div>';
                    return;
                }
                const grouped = groupHabits(habits);
                
                for (const l1 in grouped) {
                    const l1Group = document.createElement('div');
                    l1Group.className = 'border border-orange-100 rounded-lg overflow-hidden mb-3';
                    
                    const l1Header = document.createElement('div');
                    l1Header.className = 'flex justify-between items-center p-3 bg-orange-50 cursor-pointer hover:bg-orange-100 transition-colors select-none';
                    l1Header.innerHTML = `
                        <h3 class="font-bold text-orange-800">${l1}</h3>
                        <span class="text-orange-400 text-xs transform transition-transform duration-200">â–¼</span>
                    `;
                    
                    const l2Container = document.createElement('div');
                    l2Container.className = 'p-3 bg-white space-y-3';
                    
                    grouped[l1].forEach(habit => {
                        const habitEl = document.createElement('div');
                        habitEl.className = 'flex items-center space-x-3 group cursor-pointer p-2 rounded-lg hover:bg-orange-50 transition-all';
                        
                        const checkbox = document.createElement('div');
                        checkbox.className = 'w-6 h-6 border-2 border-orange-300 rounded-md flex items-center justify-center text-white bg-white group-hover:border-orange-400 transition-all shadow-sm';
                        
                        habitEl.onclick = (e) => {
                            if(habitEl.dataset.clicking) return;
                            habitEl.dataset.clicking = "true";
                            
                            checkbox.classList.add('bg-orange-500', 'border-orange-500');
                            checkbox.innerHTML = 'âœ“';
                            
                            checkIn(habit.l2);
                            
                            setTimeout(() => {
                                checkbox.classList.remove('bg-orange-500', 'border-orange-500');
                                checkbox.innerHTML = '';
                                delete habitEl.dataset.clicking;
                            }, 300);
                        };
                        
                        const name = document.createElement('span');
                        name.className = 'text-gray-700 font-medium select-none';
                        name.textContent = habit.l2;
                        
                        habitEl.appendChild(checkbox);
                        habitEl.appendChild(name);
                        l2Container.appendChild(habitEl);
                    });
                    
                    l1Header.onclick = () => {
                        if (l2Container.style.display === 'none') {
                            l2Container.style.display = 'block';
                            l1Header.querySelector('span').classList.remove('-rotate-90');
                        } else {
                            l2Container.style.display = 'none';
                            l1Header.querySelector('span').classList.add('-rotate-90');
                        }
                    };
                    
                    l1Group.appendChild(l1Header);
                    l1Group.appendChild(l2Container);
                    habitChecklistContainer.appendChild(l1Group);
                }
            }

            function checkIn(habitName) {
                log.push({ habit: habitName, time: Date.now() });
                saveLog();
                showFeedback(habitName);
                renderAllStats();
            }

            function showFeedback(habitName) {
                toastMessage.textContent = `æ­å–œä½ å·²å®Œæˆâ€œ${habitName}â€ä¹ æƒ¯çš„æ‰“å¡`;
                toastMessage.classList.remove('hidden', 'scale-95', 'opacity-0');
                toastMessage.classList.add('scale-100', 'opacity-100');
                
                fireworksOverlay.classList.add('active');
                createFireworks(30);

                setTimeout(() => {
                    fireworksOverlay.classList.remove('active');
                    fireworksOverlay.innerHTML = '';
                }, 300);

                setTimeout(() => {
                    toastMessage.classList.remove('scale-100', 'opacity-100');
                    toastMessage.classList.add('scale-95', 'opacity-0');
                    setTimeout(() => toastMessage.classList.add('hidden'), 300);
                }, 1300);
            }
            
            function showToast(msg, bgClass) {
                const el = document.createElement('div');
                el.className = `fixed top-20 left-1/2 -translate-x-1/2 ${bgClass || 'bg-gray-700'} text-white px-4 py-2 rounded-lg shadow-lg z-50 text-sm transition-opacity duration-500 opacity-0`;
                el.textContent = msg;
                document.body.appendChild(el);
                requestAnimationFrame(() => el.classList.remove('opacity-0'));
                setTimeout(() => {
                    el.classList.add('opacity-0');
                    setTimeout(() => el.remove(), 500);
                }, 2000);
            }

            function createFireworks(count) {
                for (let i = 0; i < count; i++) {
                    const firework = document.createElement('div');
                    firework.className = 'firework';
                    const top = 20 + Math.random() * 60;
                    const left = 20 + Math.random() * 60;
                    firework.style.top = `${top}vh`;
                    firework.style.left = `${left}vw`;
                    
                    const angle = Math.random() * Math.PI * 2;
                    const distance = 100 + Math.random() * 150;
                    const tx = `${Math.cos(angle) * distance}px`;
                    const ty = `${Math.sin(angle) * distance}px`;
                    
                    firework.style.setProperty('--tx', tx);
                    firework.style.setProperty('--ty', ty);
                    firework.style.backgroundColor = `hsl(${Math.random() * 360}, 80%, 60%)`;
                    
                    fireworksOverlay.appendChild(firework);
                }
            }
            
            function getFormattedDate(timestamp) {
                const d = new Date(timestamp);
                return `${d.getFullYear()}.${d.getMonth() + 1}.${d.getDate()}`;
            }

            // --- Stats ---
            function renderAllStats() {
                renderDailyLog();
                renderMonthlyStats();
                renderDailyChart();
            }

            function renderDailyLog() {
                dailyLogList.innerHTML = '';
                const todayStr = getFormattedDate(Date.now());
                const todayLog = log.filter(entry => getFormattedDate(entry.time) === todayStr);

                if (todayLog.length === 0) {
                    dailyLogList.innerHTML = '<div class="text-gray-400 text-sm italic text-center py-4">ä»Šå¤©è¿˜æ²¡æœ‰æ‰“å¡å“¦ï¼ŒåŠ æ²¹ï¼</div>';
                    return;
                }

                const grouped = todayLog.reduce((acc, entry) => {
                    if (!acc[entry.habit]) acc[entry.habit] = [];
                    acc[entry.habit].push(entry.time);
                    return acc;
                }, {});

                for (const habitName in grouped) {
                    const times = grouped[habitName];
                    const count = times.length;
                    
                    const logEl = document.createElement('div');
                    logEl.className = 'bg-orange-50 rounded-lg p-2';
                    
                    const headerEl = document.createElement('div');
                    headerEl.className = 'flex items-center justify-between';
                    
                    const leftDiv = document.createElement('div');
                    leftDiv.className = 'flex items-center space-x-2';
                    
                    const nameEl = document.createElement('span');
                    nameEl.className = 'font-semibold text-orange-900';
                    nameEl.textContent = habitName;
                    leftDiv.appendChild(nameEl);
                    
                    if (count > 0) {
                        const countEl = document.createElement('span');
                        countEl.className = 'text-xs font-bold bg-white text-orange-600 border border-orange-200 px-2 py-0.5 rounded-full';
                        countEl.textContent = `${count}æ¬¡`;
                        leftDiv.appendChild(countEl);
                    }
                    
                    if (count > 1) {
                        headerEl.classList.add('cursor-pointer');
                        const hint = document.createElement('span');
                        hint.className = 'text-xs text-orange-400';
                        hint.textContent = 'å±•å¼€è¯¦æƒ… â–¾';
                        headerEl.appendChild(leftDiv);
                        headerEl.appendChild(hint);
                    } else {
                        headerEl.appendChild(leftDiv);
                        const timeSpan = document.createElement('span');
                        timeSpan.className = 'text-xs text-orange-500';
                        timeSpan.textContent = new Date(times[0]).toLocaleTimeString('zh-CN', {hour: '2-digit', minute:'2-digit'});
                        headerEl.appendChild(timeSpan);
                    }
                    
                    logEl.appendChild(headerEl);

                    if (count > 1) {
                        const timesList = document.createElement('ul');
                        timesList.className = 'hidden mt-2 space-y-1 pl-2 border-l-2 border-orange-200';
                        times.forEach(time => {
                            const timeItem = document.createElement('li');
                            timeItem.className = 'text-xs text-gray-600';
                            timeItem.textContent = new Date(time).toLocaleTimeString('zh-CN');
                            timesList.appendChild(timeItem);
                        });
                        
                        headerEl.onclick = () => {
                            timesList.classList.toggle('hidden');
                        };
                        logEl.appendChild(timesList);
                    }
                    
                    dailyLogList.appendChild(logEl);
                }
            }

            function renderMonthlyStats() {
                monthlyStatsList.innerHTML = '';
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();
                
                const monthLog = log.filter(entry => {
                    const d = new Date(entry.time);
                    return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                });

                if (monthLog.length === 0) {
                    monthlyStatsList.innerHTML = '<div class="text-gray-400 text-sm italic text-center py-4">æœ¬æœˆæš‚æ— æ•°æ®ã€‚</div>';
                    return;
                }

                const grouped = monthLog.reduce((acc, entry) => {
                    acc[entry.habit] = (acc[entry.habit] || 0) + 1;
                    return acc;
                }, {});
                
                const sorted = Object.entries(grouped).sort(([, countA], [, countB]) => countB - countA);

                sorted.forEach(([habitName, count], index) => {
                    if (count < 1) return;

                    const statEl = document.createElement('div');
                    statEl.className = 'flex items-center p-2 hover:bg-orange-50 rounded-lg transition-colors';
                    
                    let badgeClass = 'bg-gray-100 text-gray-600';
                    if (index === 0) badgeClass = 'bg-yellow-100 text-yellow-700 font-bold';
                    if (index === 1) badgeClass = 'bg-gray-200 text-gray-700 font-bold';
                    if (index === 2) badgeClass = 'bg-orange-100 text-orange-700 font-bold';

                    statEl.innerHTML = `
                        <div class="flex items-center flex-1">
                            <span class="w-6 h-6 flex items-center justify-center rounded-full text-xs mr-3 ${badgeClass}">${index + 1}</span>
                            <span class="text-gray-800 font-medium">${habitName}</span>
                        </div>
                        <div class="w-full bg-gray-100 rounded-full h-2.5 max-w-[100px] mr-3 hidden sm:block">
                            <div class="bg-orange-400 h-2.5 rounded-full" style="width: ${Math.min(100, (count / sorted[0][1]) * 100)}%"></div>
                        </div>
                        <span class="font-bold text-orange-600 text-sm">${count} æ¬¡</span>
                    `;
                    monthlyStatsList.appendChild(statEl);
                });
            }

            function renderDailyChart() {
                if (!chartCanvas) return;

                const groupedByDay = log.reduce((acc, entry) => {
                    const dateStr = getFormattedDate(entry.time);
                    acc[dateStr] = (acc[dateStr] || 0) + 1;
                    return acc;
                }, {});

                const sortedEntries = Object.entries(groupedByDay).sort((a, b) => {
                    const partsA = a[0].split('.').map(Number);
                    const partsB = b[0].split('.').map(Number);
                    return new Date(partsA[0], partsA[1]-1, partsA[2]) - new Date(partsB[0], partsB[1]-1, partsB[2]);
                });
                
                const labels = sortedEntries.map(entry => entry[0]);
                const data = sortedEntries.map(entry => entry[1]);

                const zoomLevel = parseInt(zoomSlider.value);
                const barWidth = zoomLevel;
                const gapWidth = barWidth / 2;
                const unitWidth = barWidth + gapWidth;
                
                const minWidth = chartBody.parentElement.clientWidth;
                const calculatedWidth = Math.max(minWidth, labels.length * unitWidth + 50);
                
                chartBody.style.width = `${calculatedWidth}px`;

                if (chartInstance) {
                    chartInstance.destroy();
                }

                if (labels.length === 0) {
                    const ctx = chartCanvas.getContext('2d');
                    ctx.clearRect(0, 0, chartCanvas.width, chartCanvas.height);
                    ctx.font = "14px Arial";
                    ctx.fillStyle = "#9ca3af";
                    ctx.textAlign = "center";
                    ctx.fillText("æš‚æ— æ‰“å¡æ•°æ®", chartCanvas.width/2, chartCanvas.height/2);
                    return;
                }

                chartInstance = new Chart(chartCanvas.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'æ‰“å¡æ€»æ•°',
                            data: data,
                            backgroundColor: data.map((_, i) => PASTEL_COLORS[i % 7]),
                            borderRadius: 4,
                            borderSkipped: false,
                            barThickness: barWidth,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        layout: { padding: { left: 10, right: 10, top: 20, bottom: 0 } },
                        scales: {
                            x: { grid: { display: false }, ticks: { font: { size: 11 }, color: '#7c2d12' } },
                            y: { beginAtZero: true, border: { display: false }, grid: { color: '#fff7ed' }, ticks: { stepSize: 1, color: '#9a3412' } }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'rgba(255, 255, 255, 0.95)',
                                titleColor: '#ea580c',
                                bodyColor: '#4b5563',
                                borderColor: '#fdba74',
                                borderWidth: 1,
                                padding: 10,
                                displayColors: false,
                                callbacks: { label: (context) => `âœ¨ å®Œæˆ ${context.raw} æ¬¡` }
                            }
                        }
                    }
                });
                
                if (calculatedWidth > minWidth) {
                    chartBody.parentElement.scrollLeft = chartBody.parentElement.scrollWidth;
                }
            }

            // --- Import/Export ---
            btnExport.addEventListener('click', () => {
                const data = {
                    habits: habits,
                    log: log,
                    version: 'v8'
                };
                const dataStr = JSON.stringify(data);
                
                navigator.clipboard.writeText(dataStr).then(() => {
                    exportStatus.classList.remove('hidden');
                    setTimeout(() => exportStatus.classList.add('hidden'), 3000);
                }).catch(err => {
                    alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶æ§åˆ¶å°ä¸­çš„æ•°æ®');
                    console.log('æ•°æ®ä»£ç :', dataStr);
                });
            });
            
            btnImport.addEventListener('click', () => {
                const rawStr = importArea.value.trim();
                if (!rawStr) {
                    showToast('è¯·è¾“å…¥æ•°æ®ä»£ç ', 'bg-red-500');
                    return;
                }
                
                try {
                    const data = JSON.parse(rawStr);
                    if (Array.isArray(data.habits) && Array.isArray(data.log)) {
                        if (confirm('âš ï¸ å¯¼å…¥å°†è¦†ç›–å½“å‰è®¾å¤‡ä¸Šçš„æ‰€æœ‰è®°å½•ï¼Œç¡®å®šå—ï¼Ÿ')) {
                            habits = data.habits;
                            log = data.log;
                            saveHabits();
                            saveLog();
                            showToast('æ•°æ®å¯¼å…¥æˆåŠŸï¼', 'bg-green-500');
                            importArea.value = '';
                            renderAddHabitList();
                            renderHabitChecklist();
                            showView('view-track');
                        }
                    } else {
                        showToast('æ•°æ®æ ¼å¼é”™è¯¯: ç¼ºå°‘ä¹ æƒ¯åˆ—è¡¨', 'bg-red-500');
                    }
                } catch(e) {
                    showToast('æ— æ•ˆçš„æ•°æ®ä»£ç ', 'bg-red-500');
                    console.error(e);
                }
            });

            // *** FIXED: ICS Export with proper CRLF and strict formatting ***
            const formatICSDate = (date) => {
                const pad = (n) => n < 10 ? '0' + n : n;
                return date.getFullYear() +
                       pad(date.getMonth() + 1) +
                       pad(date.getDate()) + 'T' +
                       pad(date.getHours()) +
                       pad(date.getMinutes()) +
                       pad(date.getSeconds());
            };

            btnExportICS.addEventListener('click', () => {
                if (log.length === 0) {
                    showToast('è¿˜æ²¡æœ‰æ‰“å¡è®°å½•å“¦', 'bg-yellow-500');
                    return;
                }

                // *** CORE FIX: Strict CRLF line endings for iOS ***
                const CRLF = '\r\n';
                
                let icsContent = [
                    'BEGIN:VCALENDAR',
                    'VERSION:2.0',
                    'PRODID:-//HabitTrackerPro//CN',
                    'CALSCALE:GREGORIAN',
                    'METHOD:PUBLISH' // Helps iOS recognition
                ].join(CRLF) + CRLF;

                log.forEach((entry, index) => {
                    const d = new Date(entry.time);
                    const dateStr = formatICSDate(d);
                    
                    // End time (5 mins)
                    const e = new Date(d.getTime() + 5 * 60 * 1000);
                    const endDateStr = formatICSDate(e);

                    // UTC timestamp for DTSTAMP (required)
                    const dtstamp = new Date().toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';

                    // Unique ID
                    const uid = `${entry.time}-${index}@habit-tracker.local`;
                    const summary = `âœ… æ‰“å¡: ${entry.habit}`;

                    const event = [
                        'BEGIN:VEVENT',
                        `UID:${uid}`,
                        `DTSTAMP:${dtstamp}`,
                        `DTSTART:${dateStr}`,
                        `DTEND:${endDateStr}`,
                        `SUMMARY:${summary}`,
                        'END:VEVENT'
                    ].join(CRLF);
                    
                    icsContent += event + CRLF;
                });

                icsContent += 'END:VCALENDAR';

                const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.setAttribute('download', 'habit_log.ics');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });

            // --- Delete Actions ---
            function initiateClearLogs() {
                deleteActionState = { type: 'LOGS', step: 1, data: null };
                modalTitle.textContent = 'âš ï¸ ç¡®è®¤æ¸…ç©ºæ—¥å¿—';
                modalText.innerHTML = 'æ‚¨ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ‰“å¡æ—¥å¿—å—ï¼Ÿ<br><span class="text-xs text-red-500">æ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚</span>';
                btnModalConfirm.textContent = 'ç¡®å®šæ¸…ç©º';
                btnModalConfirm.className = 'px-5 py-2 bg-red-500 text-white rounded-xl font-medium hover:bg-red-600 shadow-md transition-colors';
                confirmModal.classList.remove('hidden');
            }
            
            function initiateDeleteHabit(l1, l2) {
                deleteActionState = { type: 'HABIT', step: 1, data: { l1, l2 } };
                modalTitle.textContent = 'âš ï¸ ç¡®è®¤åˆ é™¤ä¹ æƒ¯';
                modalText.innerHTML = `æ‚¨ç¡®å®šè¦åˆ é™¤ä¹ æƒ¯ â€œ<strong class="text-red-600">${l2}</strong>â€ å—ï¼Ÿ<br><span class="text-xs text-gray-500">ï¼ˆå†å²æ‰“å¡è®°å½•å°†ä¿ç•™ï¼‰</span>`;
                btnModalConfirm.textContent = 'ç¡®å®šåˆ é™¤';
                btnModalConfirm.className = 'px-5 py-2 bg-red-500 text-white rounded-xl font-medium hover:bg-red-600 shadow-md transition-colors';
                confirmModal.classList.remove('hidden');
            }

            function cancelModal() {
                deleteActionState = { type: null, data: null, step: 0 };
                confirmModal.classList.add('hidden');
                btnModalConfirm.classList.remove('animate-pulse', 'bg-red-700', 'hover:bg-red-800');
                btnModalConfirm.classList.add('bg-red-500', 'hover:bg-red-600');
            }
            
            function confirmModalAction() {
                const { type, step, data } = deleteActionState;

                if (type === 'LOGS') {
                    if (step === 1) {
                        deleteActionState.step = 2;
                        modalText.innerHTML = '<span class="text-red-600 font-bold">æœ€åè­¦å‘Šï¼</span><br>æ‰€æœ‰å†å²æ•°æ®éƒ½å°†æ°¸ä¹…æ¶ˆå¤±ã€‚';
                        btnModalConfirm.textContent = 'æ˜¯çš„ï¼Œå…¨éƒ¨åˆ é™¤';
                        btnModalConfirm.className = 'px-5 py-2 bg-red-700 text-white rounded-xl font-bold hover:bg-red-800 shadow-lg transition-colors animate-pulse';
                    } else if (step === 2) {
                        log = [];
                        saveLog();
                        renderAllStats();
                        cancelModal();
                        showToast('æ•°æ®å·²æ¸…ç©º', 'bg-gray-600');
                    }
                } else if (type === 'HABIT') {
                    if (step === 1) {
                        deleteActionState.step = 2;
                        modalText.innerHTML = `<span class="text-red-600 font-bold">çœŸçš„è¦åˆ é™¤ â€œ${data.l2}â€ å—ï¼Ÿ</span><br>æ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`;
                        btnModalConfirm.textContent = 'æ°¸ä¹…åˆ é™¤æ­¤ä¹ æƒ¯';
                        btnModalConfirm.className = 'px-5 py-2 bg-red-700 text-white rounded-xl font-bold hover:bg-red-800 shadow-lg transition-colors animate-pulse';
                    } else if (step === 2) {
                        habits = habits.filter(h => !(h.l1 === data.l1 && h.l2 === data.l2));
                        saveHabits();
                        renderAddHabitList();
                        renderHabitChecklist();
                        cancelModal();
                        showToast('ä¹ æƒ¯å·²åˆ é™¤', 'bg-gray-600');
                    }
                }
            }

            // --- Event Listeners ---
            navAdd.addEventListener('click', () => showView('view-add'));
            navTrack.addEventListener('click', () => showView('view-track'));
            navSettings.addEventListener('click', () => showView('view-settings'));
            
            btnAddHabit.addEventListener('click', addHabit);
            
            btnInitiateClearLogs.addEventListener('click', initiateClearLogs);
            btnModalCancel.addEventListener('click', cancelModal);
            btnModalConfirm.addEventListener('click', confirmModalAction);
            
            let resizeTimer;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(() => {
                    if (viewTrack.classList.contains('active')) {
                        renderDailyChart();
                    }
                }, 200);
            });
            
            zoomSlider.addEventListener('input', () => renderDailyChart());
        });
    </script>
</body>
</html>
